<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>INFINITEX — لوحة التحكم (Live)</title>
  <link rel="icon" href="../assets/icons/icon-192.png" />
  <style>
    :root{
      --bg:#050607;
      --bg2:#0a0c0d;
      --text:#eef2f3;
      --muted:rgba(238,242,243,.72);
      --muted2:rgba(238,242,243,.52);
      --line:rgba(255,255,255,.10);
      --accent:#39ff14;
      --card:rgba(255,255,255,.03);
      --shadow:0 24px 90px rgba(0,0,0,.60);
      --r:18px;
      --r2:24px;
      --max:1200px;
    }
    *{box-sizing:border-box}
    body{margin:0;color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif;
      background:
        radial-gradient(1100px 560px at 80% -10%, rgba(57,255,20,.18), transparent 60%),
        radial-gradient(800px 440px at 20% 0%, rgba(57,255,20,.10), transparent 60%),
        linear-gradient(180deg,var(--bg) 0%,var(--bg2) 100%);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:var(--max);margin:0 auto;padding:18px 16px 90px}

    .top{position:sticky;top:12px;z-index:50;backdrop-filter: blur(14px);
      background:rgba(0,0,0,.72);border:1px solid rgba(255,255,255,.08);border-radius:22px;
      padding:14px 14px;box-shadow:var(--shadow)}
    .topRow{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:22px}
    .chip{display:inline-flex;align-items:center;gap:10px;padding:10px 12px;border-radius:999px;border:1px solid rgba(57,255,20,.28);
      background:rgba(57,255,20,.08);color:var(--muted);font-weight:800;font-size:13px}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--accent);box-shadow:0 0 18px rgba(57,255,20,.6)}

    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text);
      padding:10px 14px;border-radius:14px;cursor:pointer;font-weight:900}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(180deg, rgba(57,255,20,.95), rgba(43,220,18,.85));border-color:rgba(57,255,20,.65);color:#061006}
    .btn.danger{border-color:rgba(255,80,80,.40);background:rgba(255,80,80,.10)}
    .btn.ghost{background:transparent}

    .grid{display:grid;grid-template-columns: 300px 1fr;gap:16px;margin-top:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.10);border-radius:var(--r2);box-shadow:var(--shadow);overflow:hidden}

    .sideHead{padding:14px 14px;border-bottom:1px solid rgba(255,255,255,.08);color:var(--muted);font-weight:900}
    .nav{display:flex;flex-direction:column}
    .nav button{width:100%;text-align:right;border:0;border-bottom:1px solid rgba(255,255,255,.06);
      background:transparent;color:var(--text);padding:12px 14px;cursor:pointer;font-weight:900}
    .nav button.active{background:rgba(57,255,20,.10);border-right:3px solid var(--accent)}
    .nav small{color:var(--muted2);font-weight:800}

    .panelHead{padding:16px 16px;border-bottom:1px solid rgba(255,255,255,.08)}
    .panelHead h1{margin:0;font-size:18px}
    .panelHead p{margin:6px 0 0;color:var(--muted);line-height:1.8}

    .form{padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:820px){.row{grid-template-columns:1fr}}

    .field{border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);border-radius:16px;padding:12px}
    .field label{display:flex;align-items:center;justify-content:space-between;gap:10px;color:var(--muted);font-weight:900;font-size:13px;margin-bottom:8px}
    .field label code{color:rgba(57,255,20,.9);font-weight:900;font-size:12px}
    input, textarea, select{
      width:100%;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:var(--text);
      padding:12px 12px;border-radius:14px;outline:none;font-size:14px
    }
    textarea{min-height:92px;resize:vertical;line-height:1.9}
    .hint{margin-top:8px;color:var(--muted2);font-size:12px;line-height:1.8}

    .notice{margin-top:10px;padding:12px 14px;border-radius:16px;border:1px solid rgba(57,255,20,.22);background:rgba(57,255,20,.06);color:var(--muted);display:none}
    .notice.show{display:block}

    .loginBox{max-width:520px;margin:10vh auto 0}
    .loginBox .form{padding:18px}

    .mediaPrev{display:flex;gap:10px;align-items:center}
    .mediaPrev img{width:64px;height:64px;border-radius:14px;object-fit:cover;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.02)}
    .mediaPrev .meta{color:var(--muted2);font-size:12px;line-height:1.7}
    .tiny{font-size:12px;color:var(--muted2)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="topRow">
        <div class="brand">
          <img src="../assets/brands/infinitex-logo.png" alt="INFINITEX" />
          <span class="chip"><span class="dot"></span> لوحة التحكم — Live</span>
        </div>
        <div class="actions" id="topActions" style="display:none">
          <button class="btn" id="btnRefresh">جلب آخر نسخة</button>
          <button class="btn" id="btnOpenReturns">فتح الاسترجاع</button>
          <button class="btn" id="btnOpenTrack">فتح التتبع</button>
          <button class="btn" id="btnOpenIndex">فتح الرئيسية</button>
          <button class="btn primary" id="btnSave">حفظ ونشر (فوري)</button>
          <button class="btn danger" id="btnLogout">تسجيل خروج</button>
        </div>
      </div>
    </div>

    <!-- Login -->
    <div id="loginView" class="loginBox card">
      <div class="panelHead">
        <h1>تسجيل الدخول</h1>
        <p>الدخول إلى لوحة التحكم يتطلب كلمة مرور. يتم التحقق من كلمة المرور عبر دالة Netlify (مشفرة/Hash) ولا يتم حفظها في المتصفح.</p>
        <div class="notice" id="loginNotice"></div>
      </div>
      <div class="form">
        <div class="field">
          <label>كلمة المرور</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="Password" />
          <div class="hint">ملاحظة: إذا لم يتم ضبط متغيرات البيئة في Netlify ستفشل عملية الدخول.</div>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
          <button class="btn primary" id="btnLogin">دخول</button>
        </div>
        <div class="tiny" style="margin-top:10px">تلميح إعداد: يجب ضبط ADMIN_PASSWORD_HASH و JWT_SECRET في Netlify.</div>
      </div>
    </div>

    <!-- App -->
    <div id="appView" style="display:none">
      <div class="grid">
        <aside class="card">
          <div class="sideHead">الأقسام</div>
          <div class="nav" id="nav">
            <button data-tab="global" class="active">عام <small>روابط + تنقل + شعارات</small></button>
            <button data-tab="returns">صفحة الاسترجاع <small>النصوص + الأزرار</small></button>
            <button data-tab="track">صفحة تتبع الطلب <small>النصوص</small></button>
            <button data-tab="index">الصفحة الرئيسية <small>الهيرو + صورة</small></button>
            <button data-tab="products">صفحة المنتجات <small>نصوص عامة</small></button>
            <button data-tab="yamm">إعدادات يم (Yamm) <small>الرابط + البراميترز</small></button>
          </div>
        </aside>

        <section class="card">
          <div class="panelHead">
            <h1 id="panelTitle">عام</h1>
            <p id="panelDesc">عدّل النصوص والوسائط ثم اضغط “حفظ ونشر” لتنعكس فوراً على الموقع (بدون رفع ملفات JSON).</p>
            <div class="notice" id="notice"></div>
          </div>

          <div class="form" id="panelBody"></div>
        </section>
      </div>
    </div>
  </div>

<script>
(function(){
  const API = {
    auth: '/api/auth',
    content: '/api/content',
    media: '/api/media'
  };

  const TOKEN_KEY = 'ix_admin_token';
  let token = sessionStorage.getItem(TOKEN_KEY) || '';
  let content = null;
  let currentTab = 'global';

  const el = {
    loginView: document.getElementById('loginView'),
    appView: document.getElementById('appView'),
    topActions: document.getElementById('topActions'),
    loginNotice: document.getElementById('loginNotice'),
    notice: document.getElementById('notice'),
    password: document.getElementById('password'),
    btnLogin: document.getElementById('btnLogin'),
    btnSave: document.getElementById('btnSave'),
    btnRefresh: document.getElementById('btnRefresh'),
    btnLogout: document.getElementById('btnLogout'),
    btnOpenReturns: document.getElementById('btnOpenReturns'),
    btnOpenTrack: document.getElementById('btnOpenTrack'),
    btnOpenIndex: document.getElementById('btnOpenIndex'),
    panelTitle: document.getElementById('panelTitle'),
    panelDesc: document.getElementById('panelDesc'),
    panelBody: document.getElementById('panelBody'),
    nav: document.getElementById('nav')
  };

  const schema = {
    global: {
      title: 'عام',
      desc: 'روابط المتجر/السياسة + التنقل + الشعارات.',
      fields: [
        { type:'url', path:'global.links.store', label:'رابط المتجر' },
        { type:'url', path:'global.links.warrantyPolicy', label:'رابط سياسة الضمان الذهبي' },
        { type:'text', path:'global.chipAfterSales', label:'شريط أعلى الصفحة (خدمات ما بعد البيع)' },

        { type:'text', path:'global.nav.home', label:'تنقل (ديسكتوب): الرئيسية' },
        { type:'text', path:'global.nav.track', label:'تنقل (ديسكتوب): تتبع الطلب' },
        { type:'text', path:'global.nav.returns', label:'تنقل (ديسكتوب): الاسترجاع' },
        { type:'text', path:'global.nav.products', label:'تنقل (ديسكتوب): المنتجات' },
        { type:'text', path:'global.nav.policy', label:'زر (ديسكتوب): سياسة الضمان الذهبي' },
        { type:'text', path:'global.nav.store', label:'زر (ديسكتوب): المتجر' },

        { type:'text', path:'global.mobileNav.services', label:'تنقل (جوال): خدمات' },
        { type:'text', path:'global.mobileNav.track', label:'تنقل (جوال): تتبع' },
        { type:'text', path:'global.mobileNav.returns', label:'تنقل (جوال): استرجاع' },
        { type:'text', path:'global.mobileNav.products', label:'تنقل (جوال): منتجات' },
        { type:'text', path:'global.mobileNav.store', label:'تنقل (جوال): متجر' },

        { type:'image', path:'global.media.infinitexLogo', label:'شعار INFINITEX' },
        { type:'image', path:'global.media.yammLogo', label:'شعار يم (Yamm)' }
      ]
    },
    returns: {
      title: 'صفحة الاسترجاع',
      desc: 'النصوص الظاهرة في أعلى صفحة الاسترجاع + نموذج التوجيه إلى يم.',
      fields: [
        { type:'text', path:'pages.returns.badge', label:'الشارة' },
        { type:'html', path:'pages.returns.title', label:'العنوان (يدعم <br/>)' },
        { type:'textarea', path:'pages.returns.desc', label:'الوصف' },
        { type:'text', path:'pages.returns.formTitle', label:'عنوان النموذج' },
        { type:'text', path:'pages.returns.orderLabel', label:'ليبل: رقم الطلب' },
        { type:'text', path:'pages.returns.orderPlaceholder', label:'Placeholder: رقم الطلب' },
        { type:'text', path:'pages.returns.phoneLabel', label:'ليبل: رقم الجوال' },
        { type:'text', path:'pages.returns.phonePlaceholder', label:'Placeholder: رقم الجوال' },
        { type:'text', path:'pages.returns.cta', label:'زر الإرسال' },
        { type:'text', path:'pages.returns.policyCta', label:'زر فتح السياسة' },
        { type:'textarea', path:'pages.returns.helper', label:'ملاحظة مختصرة' }
      ]
    },
    track: {
      title: 'صفحة تتبع الطلب',
      desc: 'النصوص الأساسية في الهيرو وزر التتبع.',
      fields: [
        { type:'text', path:'pages.track.badge', label:'الشارة' },
        { type:'html', path:'pages.track.title', label:'العنوان (يدعم <br/>)' },
        { type:'textarea', path:'pages.track.desc', label:'الوصف' },
        { type:'text', path:'pages.track.orderPlaceholder', label:'Placeholder: رقم الطلب' },
        { type:'text', path:'pages.track.cta', label:'زر التتبع' },
        { type:'textarea', path:'pages.track.hint', label:'ملاحظة تحت الإدخال' },
        { type:'text', path:'pages.track.openChat', label:'نص رابط فتح الشات' }
      ]
    },
    index: {
      title: 'الصفحة الرئيسية',
      desc: 'الهيرو (شريحة + عنوان + وصف) وصورة.',
      fields: [
        { type:'text', path:'pages.index.badge', label:'الشارة' },
        { type:'textarea', path:'pages.index.title', label:'العنوان (نص عادي)' },
        { type:'textarea', path:'pages.index.desc', label:'الوصف' },
        { type:'text', path:'pages.index.ctaTrack', label:'زر: تتبع الطلب' },
        { type:'text', path:'pages.index.ctaReturns', label:'زر: بدء الاسترجاع' },
        { type:'image', path:'pages.index.heroImage', label:'صورة الهيرو' }
      ]
    },
    products: {
      title: 'صفحة المنتجات',
      desc: 'نصوص عامة (قابلة للتوسعة).',
      fields: [
        { type:'text', path:'pages.products.badge', label:'الشارة' },
        { type:'text', path:'pages.products.title', label:'العنوان' },
        { type:'textarea', path:'pages.products.desc', label:'الوصف' },
        { type:'text', path:'pages.products.ctaStore', label:'زر زيارة المتجر' }
      ]
    },
    yamm: {
      title: 'إعدادات يم (Yamm)',
      desc: 'تحديد رابط يم وأسماء البراميترز حتى تنعكس القيم داخل منصة يم بشكل صحيح.',
      fields: [
        { type:'url', path:'yamm.baseUrl', label:'Base URL لبوابة يم' },
        { type:'text', path:'yamm.hostname', label:'Hostname (دومين المتجر)' },
        { type:'text', path:'yamm.phone.countryCode', label:'كود الدولة (للسعودية: 966)' },
        { type:'text', path:'yamm.params.hostname', label:'اسم براميتر الدومين' },
        { type:'text', path:'yamm.params.order', label:'اسم براميتر رقم الطلب' },
        { type:'text', path:'yamm.params.phone', label:'اسم براميتر رقم الجوال' },
        { type:'text', path:'yamm.params.countryCode', label:'اسم براميتر كود الدولة (اختياري)' }
      ]
    }
  };

  function showNotice(msg, ok=true, where='notice'){
    const box = where==='login' ? el.loginNotice : el.notice;
    box.textContent = msg;
    box.style.borderColor = ok ? 'rgba(57,255,20,.22)' : 'rgba(255,80,80,.35)';
    box.style.background = ok ? 'rgba(57,255,20,.06)' : 'rgba(255,80,80,.10)';
    box.classList.add('show');
    setTimeout(()=>box.classList.remove('show'), 3500);
  }

  function getByPath(obj, path){
    try{ return path.split('.').reduce((o,k)=> (o && k in o) ? o[k] : undefined, obj); }catch{ return undefined; }
  }
  function setByPath(obj, path, value){
    const parts = path.split('.');
    let cur = obj;
    for(let i=0;i<parts.length-1;i++){
      const k = parts[i];
      if(!cur[k] || typeof cur[k] !== 'object') cur[k] = {};
      cur = cur[k];
    }
    cur[parts[parts.length-1]] = value;
  }

  function resolveMedia(v){
    if(!v) return '';
    const s = String(v);
    if(s.startsWith('media/')) return `/api/media?key=${encodeURIComponent(s)}`;
    return s;
  }

  async function api(url, opts={}){
    const headers = Object.assign({ 'Content-Type':'application/json' }, opts.headers||{});
    if(token) headers['Authorization'] = 'Bearer ' + token;
    const res = await fetch(url, Object.assign({}, opts, { headers }));
    const txt = await res.text();
    let json = null;
    try{ json = txt ? JSON.parse(txt) : null; }catch{}
    if(!res.ok) throw new Error(json?.error || txt || ('HTTP '+res.status));
    return json;
  }

  async function loadContent(){
    const res = await fetch(API.content, { cache:'no-store' });
    const json = await res.json();
    content = json;
  }

  function renderTab(tab){
    currentTab = tab;
    [...el.nav.querySelectorAll('button')].forEach(b=> b.classList.toggle('active', b.dataset.tab===tab));

    const cfg = schema[tab];
    el.panelTitle.textContent = cfg.title;
    el.panelDesc.textContent = cfg.desc;

    const frag = document.createDocumentFragment();
    const row = document.createElement('div');
    row.className = 'row';

    cfg.fields.forEach(field => {
      const box = document.createElement('div');
      box.className = 'field';
      const label = document.createElement('label');
      label.innerHTML = `<span>${escapeHtml(field.label)}</span><code>${escapeHtml(field.path)}</code>`;
      box.appendChild(label);

      const val = getByPath(content, field.path);

      if(field.type === 'textarea'){
        const ta = document.createElement('textarea');
        ta.value = val ?? '';
        ta.addEventListener('input', ()=> setByPath(content, field.path, ta.value));
        box.appendChild(ta);
      } else if(field.type === 'html'){
        const ta = document.createElement('textarea');
        ta.value = val ?? '';
        ta.addEventListener('input', ()=> setByPath(content, field.path, ta.value));
        const h = document.createElement('div');
        h.className = 'hint';
        h.textContent = 'يدعم <br/> للنزول سطر.';
        box.appendChild(ta);
        box.appendChild(h);
      } else if(field.type === 'image'){
        const wrap = document.createElement('div');
        wrap.className = 'mediaPrev';
        const img = document.createElement('img');
        img.src = resolveMedia(val) || '../assets/icons/icon-192.png';
        img.alt = 'preview';
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `<div>المسار الحالي:</div><div><code style="color:rgba(57,255,20,.9)">${escapeHtml(String(val||''))}</code></div>`;
        wrap.appendChild(img);
        wrap.appendChild(meta);

        const inp = document.createElement('input');
        inp.type = 'file';
        inp.accept = 'image/*';
        inp.style.marginTop = '10px';

        inp.addEventListener('change', async ()=>{
          const file = inp.files && inp.files[0];
          if(!file) return;
          try{
            const dataUrl = await readAsDataUrl(file);
            const up = await api(API.media, { method:'POST', body: JSON.stringify({ dataUrl, filename:file.name }) });
            setByPath(content, field.path, up.key);
            img.src = up.url;
            meta.innerHTML = `<div>تم الرفع:</div><div><code style="color:rgba(57,255,20,.9)">${escapeHtml(up.key)}</code></div>`;
            showNotice('تم رفع الصورة. اضغط "حفظ ونشر" لتطبيقها على الصفحات.', true);
          } catch(err){
            showNotice('فشل رفع الصورة: ' + err.message, false);
          } finally {
            inp.value = '';
          }
        });

        box.appendChild(wrap);
        box.appendChild(inp);
        const h = document.createElement('div');
        h.className = 'hint';
        h.textContent = 'سقف الرفع ~2.5MB. سيتم تخزين الصورة في Netlify Blobs وربطها تلقائياً.';
        box.appendChild(h);
      } else {
        const input = document.createElement('input');
        input.type = (field.type === 'url') ? 'url' : 'text';
        input.value = val ?? '';
        input.addEventListener('input', ()=> setByPath(content, field.path, input.value));
        box.appendChild(input);
      }

      row.appendChild(box);
    });

    frag.appendChild(row);
    el.panelBody.innerHTML = '';
    el.panelBody.appendChild(frag);
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }

  function readAsDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result||''));
      r.onerror = ()=> reject(new Error('FileReader error'));
      r.readAsDataURL(file);
    });
  }

  async function login(){
    try{
      const pass = el.password.value;
      if(!pass) return showNotice('اكتب كلمة المرور.', false, 'login');
      const res = await fetch(API.auth, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ password: pass })
      });
      const j = await res.json().catch(()=>null);
      if(!res.ok) throw new Error(j?.error || 'Login failed');
      token = j.token;
      sessionStorage.setItem(TOKEN_KEY, token);

      await loadContent();
      bootApp();
      showNotice('تم تسجيل الدخول.', true);
    } catch(err){
      showNotice('فشل الدخول: ' + err.message, false, 'login');
    }
  }

  async function save(){
    try{
      await api(API.content, { method:'PUT', body: JSON.stringify(content) });
      // Ask open pages to refresh immediately
      try{ new BroadcastChannel('ix_content').postMessage({ type:'refresh' }); }catch{}
      showNotice('تم الحفظ. التغييرات ستظهر فوراً (وقد تحتاج 20 ثانية كحد أقصى بسبب التحديث التلقائي).', true);
    } catch(err){
      showNotice('فشل الحفظ: ' + err.message, false);
    }
  }

  async function refresh(){
    try{
      await loadContent();
      renderTab(currentTab);
      showNotice('تم جلب آخر نسخة.', true);
    } catch(err){
      showNotice('فشل الجلب: ' + err.message, false);
    }
  }

  function logout(){
    sessionStorage.removeItem(TOKEN_KEY);
    token = '';
    content = null;
    el.appView.style.display = 'none';
    el.topActions.style.display = 'none';
    el.loginView.style.display = '';
    el.password.value = '';
  }

  function bootApp(){
    el.loginView.style.display = 'none';
    el.appView.style.display = '';
    el.topActions.style.display = '';
    renderTab('global');
  }

  // Events
  el.btnLogin.addEventListener('click', login);
  el.password.addEventListener('keydown', (e)=>{ if(e.key==='Enter') login(); });
  el.btnSave.addEventListener('click', save);
  el.btnRefresh.addEventListener('click', refresh);
  el.btnLogout.addEventListener('click', logout);

  el.btnOpenReturns.addEventListener('click', ()=> window.open('../returns.html', '_blank', 'noopener'));
  el.btnOpenTrack.addEventListener('click', ()=> window.open('../track.html', '_blank', 'noopener'));
  el.btnOpenIndex.addEventListener('click', ()=> window.open('../index.html', '_blank', 'noopener'));

  el.nav.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-tab]');
    if(!btn) return;
    renderTab(btn.dataset.tab);
  });

  // Boot
  (async function init(){
    if(!token){
      el.loginView.style.display = '';
      return;
    }
    try{
      await loadContent();
      bootApp();
    } catch(err){
      // token expired or backend not configured
      logout();
    }
  })();
})();
</script>
</body>
</html>
